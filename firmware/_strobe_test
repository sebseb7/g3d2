#!/usr/bin/perl

use Device::SerialPort;
use Time::HiRes qw(usleep time);

use strict;

my $hostname = `hostname`;
chomp $hostname;

my $port = "/dev/cu.usbserial-A2002QDi";
if($hostname eq 'lennyvm')
{
    $port = '/dev/ttyUSB0';
}
    
    
my $port = Device::SerialPort->new($port);
$port->databits(8);
$port->baudrate(500000);
$port->parity("none");
$port->stopbits(1);
 
my $z = 0;

while(1)
{
	my $time1 = time;
	$port->write(chr(35));
	for(0..72)
	{
		$port->write(esc(chr(0) x 32));
	}
	usleep(12000);

	$port->write(chr(35));
	for(0..72)
	{
		$port->write(esc(chr(15) x 32));
	}
	usleep(12000);

	warn (1 / (time - $time1))*2;
}

$port->close();

sub esc($)
{
    my $data = shift;
    
	$data =~ s/e/\x65\x3/go;
	$data =~ s/\x23/\x65\x1/go;
	$data =~ s/B/\x65\x2/go;
	$data =~ s/f/\x65\x4/go;
                    
	return $data;
}
                        