#!/usr/bin/perl

use Device::SerialPort;
use Time::HiRes qw(usleep time sleep);

use strict;

my $hostname = `hostname`;
chomp $hostname;

my $port = "/dev/cu.usbserial-A2002QDi";
if($hostname eq 'lennyvm')
{
    $port = '/dev/ttyUSB0';
}
    
    
my $port = Device::SerialPort->new($port);
$port->databits(8);
$port->baudrate(500000);
$port->parity("none");
$port->stopbits(1);
 
my $z = 0;

while(1)
{
	$z+=0.004;
	$port->write(chr(35));
	my $time1 = time;
 

	my $pixel = 0;
	my $mod = 0;
	while(1)
	{

		my $str;
		foreach my $i (0..7)
		{
			
			my $x = ($pixel % 8)+(($mod%9)*8);
#			warn $x;

			my $y= ($pixel-($pixel%8))/8;
#warn $pixel.':'.$x.':'.$y.':'.$mod;
#sleep(0.3);
			my $num = abs sin($x*3+4*cos($z))*40*sin($z*2);
			$num += abs sin($y*3-3*cos($z/2))*30 + cos($y*3-sin($z*3))*25;
#			$num += sin($z);	
		
			$num = int($num)%32;
		
			if($num > 15)
			{
				$num = 32-$num;
			}

			$num=1 if $num==0;
			$str.=chr($num);
#		$str.=chr(15);

			if(($x == 8)and($y==2))
			{
		#		$str.=chr(15);
		#		die;
				
			}
			elsif(($x == 0)and($y==0))
			{
		#		$str.=chr(15);
			}
			else
			{
		#		$str.=chr(0);
			}
			$pixel++;
		}
		$port->write(esc($str));
		
		if($pixel == 64)
		{
			$mod++;
			$pixel=0;
			if($mod == 32)
			{
				last;
			}
		}
		
	
	}

	usleep(4000);

	warn 1 / (time - $time1);
}

$port->close();

sub esc($)
{
    my $data = shift;
    
	$data =~ s/e/\x65\x3/go;
	$data =~ s/\x23/\x65\x1/go;
	$data =~ s/B/\x65\x2/go;
	$data =~ s/f/\x65\x4/go;
                    
	return $data;
}
                        